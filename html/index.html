<html>
<head>
	<title> Test ui</title>
	<link rel="stylesheet" href="main.css" />
	<script>
	var x
	var previousDps = ''

	function xhr(url, cb) {
		x = new XMLHttpRequest();
		pending = true;
		x.open("GET", "api/" + url, true);
		x.onload = cb;
		x.send();
		return;
	}

	function stripOuterHTML(str) {
		return str.replace(/\'|^<[^>]+>|<\/[^>]+><[^\/][^>]*>|<\/[^>]+>$/g, '')
	}


	function Clipboard() {
		var copyText = document.getElementById("txt");
		copyText.select();
		document.execCommand("copy");
	}

	function validate(evt) {
		var theEvent = evt || window.event;
		var key = theEvent.keyCode || theEvent.which;
		key = String.fromCharCode( key );
		var regex = /[0-9]|\./;
		if( !regex.test(key) ) {
			theEvent.returnValue = false;
			if(theEvent.preventDefault) theEvent.preventDefault();
		}
	}


	function warningMsg()
	{
		_tera_client_proxy_.alert("Please remember TDM is not for mocking others. It is at your own risk to get banned by sending dps data");
	}

	function Whisper() {
		warningMsg()
		var name = document.getElementById("name").value;
		xhr("0W"+ name,null)
	}

	function ToGuild() {
		warningMsg()
		xhr("2C",null)
	}

	function ToParty() {
		warningMsg()
		xhr("1C",null)
	}

	function LeaveParty() {
		xhr("L",null)
	}

	function Reset() {
		xhr("S",null)
	}
	function CloseDpsCB() {
		_tera_client_proxy_.close()
	}
	function CloseDps() {
		xhr("P",CloseDpsCB)
	}

	// settings
	function NoticeDamageAdd() {
		xhr("A",Settings)
	}

	function Debug() {
		xhr("B",Settings)
	}

	function Notice() {
		xhr("N",Settings)
	}

	function AllUsers() {
		xhr("U",Settings)
	}
	function BossOnly() {
		xhr("O", Settings)
	}
	function HideNames()
	{
		xhr("I",Settings)
	}

	function Manager()
	{
		xhr("M",null)
	}

	function Journal()
	{
		xhr("J",null)
	}

	function ReloadTDM()
	{
		xhr("X",refreshCB)
	}

	function UpdateCB()
	{
		var dpsmsg = this.responseText.substring(1, this.responseText.length - 1)
		document.getElementById("status").innerHTML = dpsmsg.replace(/(\\n|\\)/gm,"");
	}
	function Update()
	{
		xhr("Q",UpdateCB)
	}

	function openweb(e) {
		//_tera_client_proxy_.alert("TDM does not support details of skill info yet.");
	}


	// history tab
	function HistoryCB() {
		var dpsmsg = this.responseText.substring(1, this.responseText.length - 1)
		document.getElementById("history").innerHTML = dpsmsg.replace(/(\\n|\\)/gm,"");
	}

	function History() {

		var wrapper = document.getElementById("wrapper");
		var settings = document.getElementById("settings");
		var history = document.getElementById("history");
		settings.style.display = "none";
		wrapper.style.display = "none";
		history.style.display = "block";

		xhr("H",HistoryCB)
	}

	// setting tab
	function SettingsCB()
	{
		var dpsmsg = this.responseText.substring(1, this.responseText.length - 1)
		document.getElementById("status").innerHTML = dpsmsg.replace(/(\\n|\\)/gm,"");
	}

	function Settings(){
		var wrapper = document.getElementById("wrapper");
		var settings = document.getElementById("settings");
		var history = document.getElementById("history");
		settings.style.display = "block";
		wrapper.style.display = "none";
		history.style.display = "none";

		xhr("Y",SettingsCB)
	}

	// dps tab
	function DPS(){
		var wrapper = document.getElementById("wrapper");
		var settings = document.getElementById("settings");
		var history = document.getElementById("history");
		settings.style.display = "none";
		wrapper.style.display = "block";
		history.style.display = "none";
	}

	function refreshCB()
	{
		if(previousDps.localeCompare(this.responseText) == 0) return
		var dpsmsg = this.responseText.substring(1, this.responseText.length - 1)
		document.getElementById("content").innerHTML = dpsmsg.replace(/(\\n|\\)/gm,"");
		document.getElementById("debug").innerHTML = dpsmsg.replace(/(\\n|\\)/gm,"");
		previousDps = this.responseText
	}

	function refreshDPS()
	{
		//_tera_client_proxy_.alert('test')
		waitForThis = false
		var i = setInterval(function(){
			if(waitForThis){
				clearInterval(i);
				return
			}
			xhr("R",refreshCB)
		}, 1000);
	}

	window.addEventListener('error', function(e) {
		_tera_client_proxy_.alert('Error: ' + e.message)
	})

	window.onbeforeunload =  function() {
		//xhr("P",CloseDpsCB)
		return null;
	}

	function setStyleCB()
	{
		document.getElementById("debug").innerHTML = this.responseText
		var data = this.responseText.substring(1, this.responseText.length - 1)
		var size = data.split(',')
		_tera_client_proxy_.resize_to(Number(size[0]), Number(size[1]))
		var divhight = 'height:' + (Number(size[1]) - 50) + 'px'
		document.getElementById('content').setAttribute("style",divhight);
		var wrapperdivhight = 'height:' + size[1] + 'px'
		document.getElementById('wrapper').setAttribute("style",wrapperdivhight);
		document.getElementById('history').setAttribute("style",wrapperdivhight);
		document.getElementById('settings').setAttribute("style",wrapperdivhight);
	}

	function readConfig()
	{
		xhr("Z",setStyleCB)
	}


	window.onload = function() {
		_tera_client_proxy_.resize_to(320, 250)
		_tera_client_proxy_.set_title('Tera DPS Monitor')
		readConfig()
		//_tera_client_proxy_.alert("Please remember TDM is not for mocking others.");
		refreshDPS()
	}

	function useBrowser(url)
	{
		_tera_client_proxy_.resize_to(1024, 768)
		window.location.href=url
	}

	</script>


</head>
<body>
	<button type="button" class=tab onclick="DPS()">DPS</button>
	<button type="button" class=tab onclick="History()">History</button>
	<button type="button" class=tab  onclick="Settings()">Settings</button>
	<button class=tab type="button" onclick="CloseDps()">Close</button><br>
	<div  id="wrapper">
		<div  id="content">
		</div >
		<input class=ipt type="text" size="1" id="name" value="">
		<button class=btn type="button" onclick="Whisper()">Whisper</button>
		<button class=btn type="button" onclick="ToParty()">ToParty</button>
		<button class=btn type="button" onclick="ToGuild()">ToGuild</button>
		<button class=btn type="button" onclick="LeaveParty()">LeaveParty</button>
		<button class=btn type="button" onclick="Reset()">Reset</button><br>

	</div>
	<div  id="history">
	</div>
	<div  id="settings">
		<br>
		Settings<br><br>
		<div id='status'>
		</div>
		<br>
		<br>
		<button class=btn type="button" onclick="NoticeDamageAdd()">Notice value</button>
		<button class=btn id="notice" onclick="Notice()">Notice</button>
		<button class=btn id="bossonly" onclick="BossOnly()">bossOnly</button>
		<button class=btn type="button" onclick="HideNames()">HideNames</button>
		<button class=btn id="notice" onclick="AllUsers()">All DPS</button><br>
		<button class=btn type="button" onclick="Update()">Update</button><br>
		<br><br><br><br><br>
		Debug<br>
		<button class=btn type="button" onclick="Debug()">Debug</button>
		<button class=btn type="button" onclick="ReloadTDM()">ReloadTDM</button>
		<button class=btn type="button" onclick="Manager()">Manager</button>
		<button class=btn type="button" onclick="Journal()">Journal</button>
		<button class=btn onclick="useBrowser('http://www.google.com')">google</button>
		<button class=btn onclick="useBrowser('http://www.youtube.com')">youtube</button>
		<br><br><br><br>
		<div style="position:relative;width:267px;height:25px;overflow:hidden;">
			<div style="position:absolute;top:-276px;left:-5px">
				<iframe width="300" height="300"
				src="https://www.youtube.com/embed/9Ugfve_qx-s?rel=0">
			</iframe>
			</div>
		</div>

		<!--
		<a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=C6BU555NMQJD6">
		<img src="https://www.paypalobjects.com/en_AU/i/btn/btn_donateCC_LG.gif">
			</a>
			<form action="https://www.paypal.com/cgi-bin/webscr" onclick="enlarge()" method="post" target="_top">
			<input type="hidden" name="cmd" value="_s-xclick">
			<input type="hidden" name="hosted_button_id" value="C6BU555NMQJD6">
			<input type="image" src="https://www.paypalobjects.com/en_AU/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal â€“ The safer, easier way to pay online!">
			<img alt="" border="0" src="https://www.paypalobjects.com/en_AU/i/scr/pixel.gif" width="1" height="1" >
		</form><br><br>

		</div>-->
	<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
	<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
	<textarea id="debug" maxLength="2000" rows="14" cols="50"></textarea>
	</div>
</body>
</html>
